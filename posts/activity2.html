<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Atividade 2 - Monitoramento de Frota</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
      #map { width:100%; height:600px; max-width:1000px }
    </style>
  </head>
  <body>
    <a href="../index.html">← Voltar</a>
    <h2>Atividade 2 — Monitoramento de Frota de Ônibus</h2>

    <p class="note">Objetivo: plotar em um mapa as paradas (pins) e a posição em tempo real dos ônibus (outros pins coloridos).</p>

    <section>
      <h3>O que foi feito</h3>
      <ul>
        <li>Criei um exemplo de mapa usando <strong>Leaflet</strong> em que as paradas são carregadas de um arquivo JSON em <code>data/bus_stops.json</code> e as posições atuais de veículos em <code>data/bus_positions.json</code>.</li>
        <li>Instruções para obter token/endpoint de uma API real estão descritas abaixo — cada aluno deve configurar seu token e substituir os dados de exemplo.</li>
      </ul>
    </section>

    <section>
      <h3>Mapa de exemplo</h3>
      <div id="map"></div>
    </section>

    <section>
      <h3>Instruções</h3>
      <ol>
        <li>Criar conta/projeto no provedor de dados (prefira a API da prefeitura/operadora local) e obter token, se necessário.</li>
        <li>Adicione a URL da API e o token (se houver) no arquivo `.env` na raiz do projeto. Exemplo em <code>.env.example</code>.
          <pre>BUS_API_URL=https://api.exemplo/veiculos
BUS_API_TOKEN=SEU_TOKEN_AQUI</pre>
        </li>
        <li>Ou execute o script diretamente passando a URL/token:
          <pre>python scripts\fetch_buses.py --url "https://api.exemplo/veiculos" --token "SEU_TOKEN" --out data\bus_positions.json</pre>
        </li>
        <li>Abra esta página; o mapa lerá o arquivo `data/bus_positions.json` e desenhará paradas (azul) e veículos (vermelho). Substitua a URL de demonstração no `.env` pela sua API real.</li>
      </ol>
      <p class="note">URL de demonstração no código: <code>https://api.exemplo/veiculos</code> — troque por sua URL real no `.env` ou via parâmetro CLI.</p>
    </section>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      // Carrega dados de exemplo e desenha o mapa.
      const map = L.map('map').setView([-23.55, -46.63], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

      // Função utilitária para criar pins de paradas e veículos
      async function loadAndPlot() {
        // Paradas (azul)
        try {
          const stopsResp = await fetch('../data/bus_stops.json');
          const stops = await stopsResp.json();
          stops.forEach(s => {
            L.circleMarker([s.lat, s.lon], { radius:6, color:'#0b63d6', fillColor:'#0b63d6', fillOpacity:0.8 })
              .bindPopup(`<strong>${s.name}</strong><br/>ID: ${s.id}`)
              .addTo(map);
          });
        } catch (e) {
          console.warn('Não foi possível carregar paradas de exemplo.');
        }

        // Posições (vermelho)
        try {
          const posResp = await fetch('../data/bus_positions.json');
          const pos = await posResp.json();
          pos.forEach(v => {
            L.marker([v.lat, v.lon], {title: v.id})
              .bindPopup(`<strong>Veículo ${v.id}</strong><br/>Linha: ${v.line}`)
              .addTo(map);
          });
        } catch (e) {
          console.warn('Não foi possível carregar posições de exemplo.');
        }
      }

      loadAndPlot();
    </script>
  </body>
</html>
